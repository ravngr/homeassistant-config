---

pkg_internet:
  command_line:
    # Fetch DNS records
    - sensor:
        name: "internet_dns_cloudflare_etoast_ipv4"
        unique_id: "3f8c9b74-54c2-457c-9260-dcfa736e2349"
        command: >-
          dig
          @1.1.1.1
          +stats
          +nocmd
          +nocomments
          +noquestion
          +time=3
          +tries=1
          +fail
          ipv4.etoast.net
          A |
          awk '/Query time:/ {print $4}'
        <<: &dig-common
          command_timeout: 4
          scan_interval: 5
          value_template: '{{ value | float / 1000 }}'
          device_class: duration
          unit_of_measurement: "s"

    - sensor:
        name: "internet_dns_cloudflare_etoast_ipv6"
        unique_id: "9ef8f64c-8243-4e01-9b37-f89eef9694ee"
        command: >-
          dig
          @2606:4700:4700::1111
          +stats
          +nocmd
          +nocomments
          +noquestion
          +time=3
          +tries=1
          +fail
          ipv6.etoast.net
          AAAA |
          awk '/Query time:/ {print $4}'
        <<: *dig-common

    - sensor:
        name: "local_dns_etoast_ipv4"
        unique_id: "94c09ff4-4cc4-4d42-822c-2ffb9fbe8310"
        command: >-
          dig
          +stats
          +nocmd
          +nocomments
          +noquestion
          +time=3
          +tries=1
          +fail
          ipv4.etoast.net
          A |
          awk '/Query time:/ {print $4}'
        <<: *dig-common

    # Check HTTP connectivity
    - sensor:
        name: "internet_http_etoast_ipv4"
        unique_id: "abe1cd20-d25b-4ca7-a3eb-a000c6487005"
        command: >-
          /config/support/curl_wrapper.sh -m 3 "https://ipv4.etoast.net/ping"
        <<: &curl-common
          value_template: "{{ value_json.time_total }}"
          json_attributes:
            - time_namelookup
            - time_connect
            - time_appconnect
            - time_pretransfer
            - time_redirect
            - time_starttransfer
          command_timeout: 4
          scan_interval: 5
          device_class: duration
          unit_of_measurement: "s"

    - sensor:
        name: "internet_http_etoast_ipv6"
        unique_id: "4b0c9b2c-897d-463a-82a8-83c888205729"
        command: >-
          /config/support/curl_wrapper.sh -m 3 "https://ipv6.etoast.net/ping"
        <<: *curl-common

  # Prometheus metrics
  sensor:
    - name: "net_gateway_mbit_rx"
      unique_id: "05a7c7c7-a621-4d81-954f-ef0a3be6fa61"
      <<: &prometheus-common
        platform: rest
        resource: !secret prometheus_api_url
        method: GET
        scan_interval: 5
        timeout: 5
      <<: &prometheus-data-size
        device_class: data_size
        icon: "mdi:router-network"
        unit_of_measurement: "Mbit"
        value_template: "{{ ((value_json.data.result[0].value[1] | int) / 1024 / 1024 * 8) | round(3) }}"
      params:
        query: "node_network_receive_bytes_total{device=\"mass-relay\",exported_device=\"vtnet7\"}"

    - name: "net_gateway_mbit_tx"
      unique_id: "de2cf410-a5b0-4062-b111-517b7628adc2"
      <<:
        - *prometheus-common
        - *prometheus-data-size
      params:
        query: "node_network_transmit_bytes_total{device=\"mass-relay\",exported_device=\"vtnet7\"}"

    - name: "stat_net_gateway_rx_rate"
      unique_id: "480950d3-6eff-445a-bbe9-8cac4de9d611"
      entity_id: "sensor.net_gateway_mbit_rx"
      <<: &rate-common
        platform: statistics
        state_characteristic: "change_second"
        max_age:
          minutes: 1

    - name: "stat_net_gateway_tx_rate"
      unique_id: "5a862731-ac33-4f65-a167-f9ca5fd26ed6"
      entity_id: "sensor.net_gateway_mbit_tx"
      <<: *rate-common

    - name: "internet_ping_google_ipv4"
      unique_id: "8ef879c0-0674-491e-a864-ab77944a4235"
      <<: *prometheus-common
      <<: &prometheus-ping
        device_class: duration
        icon: "mdi:timer-outline"
        unit_of_measurement: "s"
        value_template: "{{ value_json.data.result[0].value[1] | float }}"
      params:
        query: "ping_rtt_worst_seconds{ip=\"8.8.8.8\"}"

    - name: "internet_ping_cloudflare_ipv4"
      unique_id: "5208e3d7-9b55-44e9-9178-b4dc93cc76b7"
      <<:
        - *prometheus-common
        - *prometheus-ping
      params:
        query: "ping_rtt_worst_seconds{ip=\"1.1.1.1\"}"

    - name: "internet_ping_etoast_ipv4"
      unique_id: "535329e5-5ec0-430c-b21a-9aa50577a447"
      <<:
        - *prometheus-common
        - *prometheus-ping
      params:
        query: "ping_rtt_worst_seconds{ip=\"119.42.53.202\"}"

  # Template sensor
  template:
    - trigger:
        - platform: time_pattern
          seconds: "/15"
      binary_sensor:
        - name: "internet_ipv4_connected"
          unique_id: "75fafe5e-57fc-4fe8-b844-3ae3e260259e"
          device_class: "connectivity"
          icon: "mdi:web"
          state: >-
            {{
              not is_state('sensor.internet_dns_cloudflare_etoast_ipv4', ['unavailable', 'unknown']) and
              (now() - states.sensor.internet_dns_cloudflare_etoast_ipv4.last_updated) <= timedelta(seconds=20) and
              not is_state('sensor.internet_http_etoast_ipv4', ['unavailable', 'unknown']) and
              (now() - states.sensor.internet_http_etoast_ipv4.last_updated) <= timedelta(seconds=20) and
              not is_state('sensor.internet_ping_etoast_ipv4', ['unavailable', 'unknown']) and
              (now() - states.sensor.internet_ping_etoast_ipv4.last_updated) <= timedelta(seconds=35)
            }}
          attributes:
            dns_ms: >-
              {{
                states('sensor.internet_dns_cloudflare_etoast_ipv4') | float(0) * 1000
              }}
            http_ms: >-
              {{
                states('sensor.internet_http_etoast_ipv4') | float(0) * 1000
              }}
            ping_ms: >-
              {{
                states('sensor.internet_ping_etoast_ipv4') | float(0) * 1000
              }}

        - name: "internet_ipv6_connected"
          unique_id: "3731f6a6-408b-4250-8ce7-5a0493db5657"
          device_class: "connectivity"
          icon: "mdi:web"
          state: >-
            {{
              not is_state('sensor.internet_dns_cloudflare_etoast_ipv6', ['unavailable', 'unknown']) and
              (now() - states.sensor.internet_dns_cloudflare_etoast_ipv6.last_updated) <= timedelta(seconds=20) and
              not is_state('sensor.internet_http_etoast_ipv6', ['unavailable', 'unknown']) and
              (now() - states.sensor.internet_http_etoast_ipv6.last_updated) <= timedelta(seconds=20) and
              not is_state('sensor.internet_ping_etoast_ipv6', ['unavailable', 'unknown']) and
              (now() - states.sensor.internet_ping_etoast_ipv6.last_updated) <= timedelta(seconds=35)
            }}
          attributes:
            dns_ms: >-
              {{
                states('sensor.internet_dns_cloudflare_etoast_ipv6') | float(0) * 1000
              }}
            http_ms: >-
              {{
                states('sensor.internet_http_etoast_ipv6') | float(0) * 1000
              }}
            ping_ms: >-
              {{
                states('sensor.internet_ping_etoast_ipv6') | float(0) * 1000
              }}

  homeassistant:
    customize:
      binary_sensor.internet_ipv4_connected:
        friendly_name: "Internet"
        <<: &web_common
          icon: "mdi:web"

      binary_sensor.internet_ipv6_connected:
        friendly_name: "Internet IPv6"
        <<: *web_common

      binary_sensor.ping_gateway:
        friendly_name: "Internet Gateway"
        <<: *web_common

      sensor.internet_dns_cloudflare_etoast_ipv4:
        friendly_name: "Cloudflare DNS IPv4 Lookup Time"
        <<: *web_common

      sensor.internet_dns_cloudflare_etoast_ipv6:
        friendly_name: "Cloudflare DNS IPv6 Lookup Time"
        <<: *web_common

      sensor.local_dns_etoast_ipv4:
        friendly_name: "Local DNS IPv4 Lookup Time"
        <<: *web_common

      sensor.internet_http_etoast_ipv4:
        friendly_name: "HTTP IPv4 Fetch Time"
        <<: *web_common

      sensor.internet_http_etoast_ipv6:
        friendly_name: "HTTP IPv6 Fetch Time"
        <<: *web_common

      sensor.net_gateway_bytes_rx:
        friendly_name: "WAN Received"
        <<: *web_common

      sensor.net_gateway_bytes_tx:
        friendly_name: "WAN Transmitted"
        <<: *web_common

      sensor.stat_net_gateway_rx_rate:
        friendly_name: "WAN Download Rate"
        icon: "mdi:download-network"
        unit_of_measurement: "Mbps"

      sensor.stat_net_gateway_tx_rate:
        friendly_name: "WAN Upload Rate"
        icon: "mdi:upload-network"
        unit_of_measurement: "Mbps"

      sensor.internet_ping_google_ipv4:
        friendly_name: "Google IPv4 Ping"
        <<: *web_common

      sensor.internet_ping_cloudflare_ipv4:
        friendly_name: "Cloudflare IPv4 Ping"
        <<: *web_common

      sensor.internet_ping_etoast_ipv4:
        friendly_name: "etoast.net IPv4 Ping"
        <<: *web_common
